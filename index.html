

<!DOCTYPE html>
<html lang="en" >

<head>

  <meta charset="UTF-8">

  <title>Chemical Zen - Sokobond in JS</title>
  
<style>
table {
  border-spacing: 0px;
}

#board {
  position:relative;
   z-index: 0;
}

#left_arrow{
 position: absolute;
  top: 50%;
  left: 0%;
   z-index: 100;
}

#right_arrow{
 position: absolute;
  top: 50%;
  left: 100%;
   z-index: 100;
}

#top_arrow{
 position: absolute;
  top: 0%;
  left: 50%;
   z-index: 100;
}

#bottom_arrow{
 position: absolute;
  top: 100%;
  left: 50%;
   z-index: 100;
}

#puzzle_title {
  font-size: larger;
  z-index: 99;
  top: 25px;
  left: 190px;
  color: white;
  text-shadow: 1px 1px 2px black, 0 0 25px blue, 0 0 5px darkblue;
}

#Item_Menu {
  border: solid;
  border-width: 1px;
}

#input_area{
font-family: "Courier New";
}

@keyframes animatezoom {
  from {
    top: 0;
    left: 0;
    transform: scale(0);
  }

  to {
    top: 25%;
    left: 25%;
    transform: scale(1);
  }
}

.win {
  position: absolute;
  top: 25%;
  left: 25%;
  width: 210px;
  z-index: 50;

  animation-name: animatezoom;
  animation-duration: 4s;
}

.win_vacuum {
  width: 100px;
  height: 100px;
}

.win_bond_vert {
  width: 10px;
  height: 100px;
}

.win_bond_horiz {
  width: 100px;
  height: 10px;
}

.win_hyperspace {
  text-align: center;
  width: 10px;
  height: 10px;
}

td {
  position: relative;
  margin: 0px;
  padding: 0px;
}

svg {
  position: absolute;
  top: 0px;
  left: 0px;
  display: block;
  overflow: visible;
}

.vacuum {
  width: 50px;
  height: 50px;
}

.bond_vert {
  width: 5px;
  height: 50px;
}

.bond_horiz {
  width: 50px;
  height: 5px;
}

.hyperspace {
  text-align: center;
  width: 5px;
  height: 5px;
}

.wall {
  background-color: CornflowerBlue;
}

.move_to {
  border: dashed;
  border-width: 1px;
}

.editor {
  border: solid;
  border-width: 1px;
}

.selected{
background-color: yellow;  
}

/*https://www.w3schools.com/w3css/4/w3pro.css*/
/* W3PRO.CSS 4.13 June 2019 by Jan Egil and Borge Refsnes */
html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}
/* Extract from normalize.css by Nicolas Gallagher and Jonathan Neal git.io/normalize */
html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}
article,aside,details,figcaption,figure,footer,header,main,menu,nav,section{display:block}summary{display:list-item}
audio,canvas,progress,video{display:inline-block}progress{vertical-align:baseline}
audio:not([controls]){display:none;height:0}[hidden],template{display:none}
a{background-color:transparent}a:active,a:hover{outline-width:0}
abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}
b,strong{font-weight:bolder}dfn{font-style:italic}mark{background:#ff0;color:#000}
small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sub{bottom:-0.25em}sup{top:-0.5em}figure{margin:1em 40px}img{border-style:none}
code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}hr{box-sizing:content-box;height:0;overflow:visible}
button,input,select,textarea,optgroup{font:inherit;margin:0}optgroup{font-weight:bold}
button,input{overflow:visible}button,select{text-transform:none}
button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}
button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}
button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}
fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:.35em .625em .75em}
legend{color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}
[type=checkbox],[type=radio]{padding:0}
[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}
[type=search]{-webkit-appearance:textfield;outline-offset:-2px}
[type=search]::-webkit-search-decoration{-webkit-appearance:none}
::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}
/* End extract */
html,body{font-family:Verdana,sans-serif;font-size:15px;line-height:1.5}html{overflow-x:hidden}
h1{font-size:36px}h2{font-size:30px}h3{font-size:24px}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px}.w3-serif{font-family:serif}
h1,h2,h3,h4,h5,h6{font-family:"Segoe UI",Arial,sans-serif;font-weight:400;margin:10px 0}.w3-wide{letter-spacing:4px}
hr{border:0;border-top:1px solid #eee;margin:20px 0}
.w3-image{max-width:100%;height:auto}img{vertical-align:middle}a{color:inherit}
.w3-table,.w3-table-all{border-collapse:collapse;border-spacing:0;width:100%;display:table}.w3-table-all{border:1px solid #ccc}
.w3-bordered tr,.w3-table-all tr{border-bottom:1px solid #ddd}.w3-striped tbody tr:nth-child(even){background-color:#f1f1f1}
.w3-table-all tr:nth-child(odd){background-color:#fff}.w3-table-all tr:nth-child(even){background-color:#f1f1f1}
.w3-hoverable tbody tr:hover,.w3-ul.w3-hoverable li:hover{background-color:#ccc}.w3-centered tr th,.w3-centered tr td{text-align:center}
.w3-table td,.w3-table th,.w3-table-all td,.w3-table-all th{padding:8px 8px;display:table-cell;text-align:left;vertical-align:top}
.w3-table th:first-child,.w3-table td:first-child,.w3-table-all th:first-child,.w3-table-all td:first-child{padding-left:16px}
.w3-btn,.w3-button{border:none;display:inline-block;padding:8px 16px;vertical-align:middle;overflow:hidden;text-decoration:none;color:inherit;background-color:inherit;text-align:center;cursor:pointer;white-space:nowrap}
.w3-btn:hover{box-shadow:0 8px 16px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19)}
.w3-btn,.w3-button{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}   
.w3-disabled,.w3-btn:disabled,.w3-button:disabled{cursor:not-allowed;opacity:0.3}.w3-disabled *,:disabled *{pointer-events:none}
.w3-btn.w3-disabled:hover,.w3-btn:disabled:hover{box-shadow:none}
.w3-badge,.w3-tag{background-color:#000;color:#fff;display:inline-block;padding-left:8px;padding-right:8px;text-align:center}.w3-badge{border-radius:50%}
.w3-ul{list-style-type:none;padding:0;margin:0}.w3-ul li{padding:8px 16px;border-bottom:1px solid #ddd}.w3-ul li:last-child{border-bottom:none}
.w3-tooltip,.w3-display-container{position:relative}.w3-tooltip .w3-text{display:none}.w3-tooltip:hover .w3-text{display:inline-block}
.w3-ripple:active{opacity:0.5}.w3-ripple{transition:opacity 0s}
.w3-input{padding:8px;display:block;border:none;border-bottom:1px solid #ccc;width:100%}
.w3-select{padding:9px 0;width:100%;border:none;border-bottom:1px solid #ccc}
.w3-dropdown-click,.w3-dropdown-hover{position:relative;display:inline-block;cursor:pointer}
.w3-dropdown-hover:hover .w3-dropdown-content{display:block}
.w3-dropdown-hover:first-child,.w3-dropdown-click:hover{background-color:#ccc;color:#000}
.w3-dropdown-hover:hover > .w3-button:first-child,.w3-dropdown-click:hover > .w3-button:first-child{background-color:#ccc;color:#000}
.w3-dropdown-content{cursor:auto;color:#000;background-color:#fff;display:none;position:absolute;min-width:160px;margin:0;padding:0;z-index:1}
.w3-check,.w3-radio{width:24px;height:24px;position:relative;top:6px}
.w3-sidebar{height:100%;width:200px;background-color:#fff;position:fixed!important;z-index:1;overflow:auto}
.w3-bar-block .w3-dropdown-hover,.w3-bar-block .w3-dropdown-click{width:100%}
.w3-bar-block .w3-dropdown-hover .w3-dropdown-content,.w3-bar-block .w3-dropdown-click .w3-dropdown-content{min-width:100%}
.w3-bar-block .w3-dropdown-hover .w3-button,.w3-bar-block .w3-dropdown-click .w3-button{width:100%;text-align:left;padding:8px 16px}
.w3-main,#main{transition:margin-left .4s}
.w3-modal{z-index:3;display:none;padding-top:100px;position:fixed;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgb(0,0,0);background-color:rgba(0,0,0,0.4)}
.w3-modal-content{margin:auto;background-color:#fff;position:relative;padding:0;outline:0;width:600px}
.w3-bar{width:100%;overflow:hidden}.w3-center .w3-bar{display:inline-block;width:auto}
.w3-bar .w3-bar-item{padding:8px 16px;float:left;width:auto;border:none;display:block;outline:0}
.w3-bar .w3-dropdown-hover,.w3-bar .w3-dropdown-click{position:static;float:left}
.w3-bar .w3-button{white-space:normal}
.w3-bar-block .w3-bar-item{width:100%;display:block;padding:8px 16px;text-align:left;border:none;white-space:normal;float:none;outline:0}
.w3-bar-block.w3-center .w3-bar-item{text-align:center}.w3-block{display:block;width:100%}
.w3-responsive{display:block;overflow-x:auto}
.w3-container:after,.w3-container:before,.w3-panel:after,.w3-panel:before,.w3-row:after,.w3-row:before,.w3-row-padding:after,.w3-row-padding:before,
.w3-cell-row:before,.w3-cell-row:after,.w3-clear:after,.w3-clear:before,.w3-bar:before,.w3-bar:after{content:"";display:table;clear:both}
.w3-col,.w3-half,.w3-third,.w3-twothird,.w3-threequarter,.w3-quarter{float:left;width:100%}
.w3-col.s1{width:8.33333%}.w3-col.s2{width:16.66666%}.w3-col.s3{width:24.99999%}.w3-col.s4{width:33.33333%}
.w3-col.s5{width:41.66666%}.w3-col.s6{width:49.99999%}.w3-col.s7{width:58.33333%}.w3-col.s8{width:66.66666%}
.w3-col.s9{width:74.99999%}.w3-col.s10{width:83.33333%}.w3-col.s11{width:91.66666%}.w3-col.s12{width:99.99999%}
@media (min-width:601px){.w3-col.m1{width:8.33333%}.w3-col.m2{width:16.66666%}.w3-col.m3,.w3-quarter{width:24.99999%}.w3-col.m4,.w3-third{width:33.33333%}
.w3-col.m5{width:41.66666%}.w3-col.m6,.w3-half{width:49.99999%}.w3-col.m7{width:58.33333%}.w3-col.m8,.w3-twothird{width:66.66666%}
.w3-col.m9,.w3-threequarter{width:74.99999%}.w3-col.m10{width:83.33333%}.w3-col.m11{width:91.66666%}.w3-col.m12{width:99.99999%}}
@media (min-width:993px){.w3-col.l1{width:8.33333%}.w3-col.l2{width:16.66666%}.w3-col.l3{width:24.99999%}.w3-col.l4{width:33.33333%}
.w3-col.l5{width:41.66666%}.w3-col.l6{width:49.99999%}.w3-col.l7{width:58.33333%}.w3-col.l8{width:66.66666%}
.w3-col.l9{width:74.99999%}.w3-col.l10{width:83.33333%}.w3-col.l11{width:91.66666%}.w3-col.l12{width:99.99999%}}
.w3-rest{overflow:hidden}.w3-stretch{margin-left:-16px;margin-right:-16px}
.w3-content,.w3-auto{margin-left:auto;margin-right:auto}.w3-content{max-width:980px}.w3-auto{max-width:1140px}
.w3-cell-row{display:table;width:100%}.w3-cell{display:table-cell}
.w3-cell-top{vertical-align:top}.w3-cell-middle{vertical-align:middle}.w3-cell-bottom{vertical-align:bottom}
.w3-hide{display:none!important}.w3-show-block,.w3-show{display:block!important}.w3-show-inline-block{display:inline-block!important}
@media (max-width:1205px){.w3-auto{max-width:95%}}
@media (max-width:600px){.w3-modal-content{margin:0 10px;width:auto!important}.w3-modal{padding-top:30px}
.w3-dropdown-hover.w3-mobile .w3-dropdown-content,.w3-dropdown-click.w3-mobile .w3-dropdown-content{position:relative}	
.w3-hide-small{display:none!important}.w3-mobile{display:block;width:100%!important}.w3-bar-item.w3-mobile,.w3-dropdown-hover.w3-mobile,.w3-dropdown-click.w3-mobile{text-align:center}
.w3-dropdown-hover.w3-mobile,.w3-dropdown-hover.w3-mobile .w3-btn,.w3-dropdown-hover.w3-mobile .w3-button,.w3-dropdown-click.w3-mobile,.w3-dropdown-click.w3-mobile .w3-btn,.w3-dropdown-click.w3-mobile .w3-button{width:100%}}
@media (max-width:768px){.w3-modal-content{width:500px}.w3-modal{padding-top:50px}}
@media (min-width:993px){.w3-modal-content{width:900px}.w3-hide-large{display:none!important}.w3-sidebar.w3-collapse{display:block!important}}
@media (max-width:992px) and (min-width:601px){.w3-hide-medium{display:none!important}}
@media (max-width:992px){.w3-sidebar.w3-collapse{display:none}.w3-main{margin-left:0!important;margin-right:0!important}.w3-auto{max-width:100%}}
.w3-top,.w3-bottom{position:fixed;width:100%;z-index:1}.w3-top{top:0}.w3-bottom{bottom:0}
.w3-overlay{position:fixed;display:none;width:100%;height:100%;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.5);z-index:2}
.w3-display-topleft{position:absolute;left:0;top:0}.w3-display-topright{position:absolute;right:0;top:0}
.w3-display-bottomleft{position:absolute;left:0;bottom:0}.w3-display-bottomright{position:absolute;right:0;bottom:0}
.w3-display-middle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%)}
.w3-display-left{position:absolute;top:50%;left:0%;transform:translate(0%,-50%);-ms-transform:translate(-0%,-50%)}
.w3-display-right{position:absolute;top:50%;right:0%;transform:translate(0%,-50%);-ms-transform:translate(0%,-50%)}
.w3-display-topmiddle{position:absolute;left:50%;top:0;transform:translate(-50%,0%);-ms-transform:translate(-50%,0%)}
.w3-display-bottommiddle{position:absolute;left:50%;bottom:0;transform:translate(-50%,0%);-ms-transform:translate(-50%,0%)}
.w3-display-container:hover .w3-display-hover{display:block}.w3-display-container:hover span.w3-display-hover{display:inline-block}.w3-display-hover{display:none}
.w3-display-position{position:absolute}
.w3-circle{border-radius:50%}
.w3-round-small{border-radius:2px}.w3-round,.w3-round-medium{border-radius:4px}.w3-round-large{border-radius:8px}.w3-round-xlarge{border-radius:16px}.w3-round-xxlarge{border-radius:32px}
.w3-row-padding,.w3-row-padding>.w3-half,.w3-row-padding>.w3-third,.w3-row-padding>.w3-twothird,.w3-row-padding>.w3-threequarter,.w3-row-padding>.w3-quarter,.w3-row-padding>.w3-col{padding:0 8px}
.w3-container,.w3-panel{padding:0.01em 16px}.w3-panel{margin-top:16px;margin-bottom:16px}
.w3-code,.w3-codespan{font-family:Consolas,"courier new";font-size:16px}
.w3-code{width:auto;background-color:#fff;padding:8px 12px;border-left:4px solid #4CAF50;word-wrap:break-word}
.w3-codespan{color:crimson;background-color:#f1f1f1;padding-left:4px;padding-right:4px;font-size:110%}
.w3-card,.w3-card-2{box-shadow:0 2px 5px 0 rgba(0,0,0,0.16),0 2px 10px 0 rgba(0,0,0,0.12)}
.w3-card-4,.w3-hover-shadow:hover{box-shadow:0 4px 10px 0 rgba(0,0,0,0.2),0 4px 20px 0 rgba(0,0,0,0.19)}
.w3-spin{animation:w3-spin 2s infinite linear}@keyframes w3-spin{0%{transform:rotate(0deg)}100%{transform:rotate(359deg)}}
.w3-animate-fading{animation:fading 10s infinite}@keyframes fading{0%{opacity:0}50%{opacity:1}100%{opacity:0}}
.w3-animate-opacity{animation:opac 0.8s}@keyframes opac{from{opacity:0} to{opacity:1}}
.w3-animate-top{position:relative;animation:animatetop 0.4s}@keyframes animatetop{from{top:-300px;opacity:0} to{top:0;opacity:1}}
.w3-animate-left{position:relative;animation:animateleft 0.4s}@keyframes animateleft{from{left:-300px;opacity:0} to{left:0;opacity:1}}
.w3-animate-right{position:relative;animation:animateright 0.4s}@keyframes animateright{from{right:-300px;opacity:0} to{right:0;opacity:1}}
.w3-animate-bottom{position:relative;animation:animatebottom 0.4s}@keyframes animatebottom{from{bottom:-300px;opacity:0} to{bottom:0;opacity:1}}
.w3-animate-zoom {animation:animatezoom 0.6s}@keyframes animatezoom{from{transform:scale(0)} to{transform:scale(1)}}
.w3-animate-input{transition:width 0.4s ease-in-out}.w3-animate-input:focus{width:100%!important}
.w3-opacity,.w3-hover-opacity:hover{opacity:0.60}.w3-opacity-off,.w3-hover-opacity-off:hover{opacity:1}
.w3-opacity-max{opacity:0.25}.w3-opacity-min{opacity:0.75}
.w3-greyscale-max,.w3-grayscale-max,.w3-hover-greyscale:hover,.w3-hover-grayscale:hover{filter:grayscale(100%)}
.w3-greyscale,.w3-grayscale{filter:grayscale(75%)}.w3-greyscale-min,.w3-grayscale-min{filter:grayscale(50%)}
.w3-sepia{filter:sepia(75%)}.w3-sepia-max,.w3-hover-sepia:hover{filter:sepia(100%)}.w3-sepia-min{filter:sepia(50%)}
.w3-tiny{font-size:10px!important}.w3-small{font-size:12px!important}.w3-medium{font-size:15px!important}.w3-large{font-size:18px!important}
.w3-xlarge{font-size:24px!important}.w3-xxlarge{font-size:36px!important}.w3-xxxlarge{font-size:48px!important}.w3-jumbo{font-size:64px!important}
.w3-left-align{text-align:left!important}.w3-right-align{text-align:right!important}.w3-justify{text-align:justify!important}.w3-center{text-align:center!important}
.w3-border-0{border:0!important}.w3-border{border:1px solid #ccc!important}
.w3-border-top{border-top:1px solid #ccc!important}.w3-border-bottom{border-bottom:1px solid #ccc!important}
.w3-border-left{border-left:1px solid #ccc!important}.w3-border-right{border-right:1px solid #ccc!important}
.w3-topbar{border-top:6px solid #ccc!important}.w3-bottombar{border-bottom:6px solid #ccc!important}
.w3-leftbar{border-left:6px solid #ccc!important}.w3-rightbar{border-right:6px solid #ccc!important}
.w3-section,.w3-code{margin-top:16px!important;margin-bottom:16px!important}
.w3-margin{margin:16px!important}.w3-margin-top{margin-top:16px!important}.w3-margin-bottom{margin-bottom:16px!important}
.w3-margin-left{margin-left:16px!important}.w3-margin-right{margin-right:16px!important}
.w3-padding-small{padding:4px 8px!important}.w3-padding{padding:8px 16px!important}.w3-padding-large{padding:12px 24px!important}
.w3-padding-16{padding-top:16px!important;padding-bottom:16px!important}.w3-padding-24{padding-top:24px!important;padding-bottom:24px!important}
.w3-padding-32{padding-top:32px!important;padding-bottom:32px!important}.w3-padding-48{padding-top:48px!important;padding-bottom:48px!important}
.w3-padding-64{padding-top:64px!important;padding-bottom:64px!important}
.w3-left{float:left!important}.w3-right{float:right!important}
.w3-button:hover{color:#000!important;background-color:#ccc!important}
.w3-transparent,.w3-hover-none:hover{background-color:transparent!important}
.w3-hover-none:hover{box-shadow:none!important}
</style>

  
  
  
  

</head>

<body translate="no" >
  <!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>CodePen - Chemical Zen - Sokobond in JS</title>
  <link rel="stylesheet" href="./style.css">

</head>
<body>
<!-- partial:index.partial.html -->
<html>

<head>
  <meta name="description" content="Chemical Zen - Sokobond in JS">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width" initial-scale="1.0">
  <title>Chemical Zen - Sokobond in JS</title>

</head>

<body ONKEYUP="Key_Input(event.keyCode);">

  <!-- https://www.w3schools.com/w3css/w3css_mobile.asp  -->
  <nav class="w3-sidebar w3-bar-block w3-card w3-animate-top" id="mySidebar">
    <div class="w3-container w3-theme-d2">
      <span onclick="closeSidebar()" class="w3-button w3-display-topright w3-large">X</span>
      <br>
    </div>
    --- Game ---
    <a class="w3-bar-item w3-button" href="https://www.sokobond.com/" onclick="closeSidebar();" target="_blank" rel="noopener">Original Sokobond</a>
    <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();alert(how_to_play);">How to play</a>
    Puzzle: <select name="puzzle_select" id="puzzle_select" onchange="closeSidebar();Load_Puzzle(this.value);this.selectedIndex=0;">
      <option value="" disabled selected>---</option>
    </select>
    <br><br>
    --- Editor ---
    <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();Editor();">Last saved edit</a>
     <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();localStorage.editor_board =   document.getElementById('input_area').value;Editor();">ASCII to update editor OR puzzle to editor</a>
    <!--
    <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();localStorage.editor_board = Board_To_ASCII() ;Editor();">Current puzzle state to editor</a>
   -->
    <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();board_mode='game';Factory_Reset();ascii=document.getElementById('input_area').value;Build_Puzzle(ascii);previous_boards.push(ascii);Save_State();localStorage.editor_board=ascii;">Build puzzle from ASCII</a>
     <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();Crop_Editor_Board();">Crop editor</a>
    <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();alert(building_a_puzzle);">ASCII codes</a>
   <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar(); localStorage.editor_board = Blank_Editor_ASCII();Editor();">Reset editor</a>
    --- Problems? ---
    <a class="w3-bar-item w3-button" href="#" onclick="closeSidebar();Factory_Reset();Game();">Factory reset</a>

  </nav>

  <header class="w3-bar w3-card w3-theme">
    <button class="w3-bar-item w3-button w3-large w3-hover-theme" onclick="openSidebar();">&#9776;</button>
    <h6 class="w3-bar-item">Chemical Zen</h6>
  </header>

  <script>
    function openSidebar() {
      document.getElementById("mySidebar").style.display = "block";
    }

    function closeSidebar() {
      document.getElementById("mySidebar").style.display = "none";
    }
    closeSidebar();
  </script>

  <center>
    <div id="board"></div>
    <br>

    <div id="ASCII">
      <p></p>
      Build Your Own Puzzle (in ASCII):
      <br>
      <textarea id="input_area" rows="4" cols="50"></textarea>
    </div>

    <p>
      <a href="https://github.com/vpelss/Sokobond_JS" target="_blank" rel="noopener">https://github.com/vpelss/Sokobond_JS</a>
    </p>
    <p>
      <a href="https://www.emogic.com" target="_blank" rel="noopener">Emogic</a>
    </p>

    <audio autoplay controls>
      <source src="http://emogic.com/Sokobond_JS/Open to the Elements.mp3_" type="audio/mpeg">
      <p>Your browser does not support the audio element.</p>
    </audio>
  </center>

  <div id="Item_Menu" class="w3-display-middle w3-code" style="display:none;">
    <a href="#" onclick="Place_Item('0');">Empty</a>
    <br>
    <div id="Item_Menu_Bonds">
      <a href="#" onclick="Place_Item('1');">Bond 1</a>
      <br>
      <a href="#" onclick="Place_Item('2');">Bond 2</a>
      <br>
      <a href="#" onclick="Place_Item('3');">Bond 3</a>
      <br>
      <a href="#" onclick="Place_Item('4');">Bond 4</a>
      <br>
    </div>
    <div id="Item_Menu_Atoms">
      <a href="#" onclick="Place_Item('W');">Wall</a>
      <br>
      <a href="#" onclick="Place_Item('h');">Atom He</a>
      <br>
      <a href="#" onclick="Place_Item('H');">Atom H</a>
      <br>
      <a href="#" onclick="Place_Item('N');">Atom N</a>
      <br>
      <a href="#" onclick="Place_Item('O');">Atom O</a>
      <br>
      <a href="#" onclick="Place_Item('C');">Atom C</a>
      <br>
      <a href="#" onclick="Make_Me();">Make this Atom Me</a>
      <br>
    </div>
    <div id="Item_Menu_Modifiers">
      <a href="#" onclick="Place_Item('-');">Splitter</a>
      <br>
      <a href="#" onclick="Place_Item('+');">Joiner</a>
      <br>
      <a href="#" onclick="Place_Item('.');">Twister</a>
      <br>
    </div>
  </div>

  <div id="win"></div>

</body>

</html>
<!-- partial -->
  <script  src="./script.js"></script>

</body>
</html>
  
  
      <script id="rendered-js" >
//global vars -----------------------
var error_msg = "";
var empty_chars = ["0"];
var atom_chars = ["H", "h", "O", "C", "N"];
var wall_chars = ["W"];
var modifier_chars = ["+", "-", "."];
var bond_chars = ["1", "2", "3", "4"];
var validate_board_pos = {}; //note: the keys (hyperspace,vacuum,bond_vert,bond_horiz) match state/class so we can easily do board error checking during the board build
validate_board_pos.hyperspace = empty_chars.concat(modifier_chars);
validate_board_pos.vacuum = empty_chars.concat(atom_chars, wall_chars);
validate_board_pos.bond_vert = empty_chars.concat(bond_chars);
validate_board_pos.bond_horiz = empty_chars.concat(bond_chars);
var direction = {
  N: {
    x: 0,
    y: -1
  },
  S: {
    x: 0,
    y: 1
  },
  E: {
    x: 1,
    y: 0
  },
  W: {
    x: -1,
    y: 0
  }
};

//allows us to save JSON.stringify(board) then easily rebuild each object on board.
var board = {}; //[x_y] can_be objects of type empty , atom , bond , bond_modifier
var molecule = {}; // will show which atoms are in same molecule or not molecule[x_y] = 1 , 2 , 3 , 4 , etc. calculate before every move. required so we can  push / pull via bonds atoms in our molecule IN OREDR. otherwise we could jump to our tail and push / pull in wrong direction by bonds....
var molecule_last_count; //set on fresh Build_Molecules(). used so we can easily split molecules when trying to move . Molecule_Split()
var board_mode = "game"; //or editor or
var move = {}; //move[x_y] = x_new_y_new , a list of moves for this turn so we can process moves if move attempt is sucessful
var atom_intended_move = {}; //atoms_intended_move[xNew_yNew] = 1; allows us to easily check to see if 2 atoms trying to occupy same space (a fail condition)
var previous_boards = []; //array for z - undo and to reset board. it will contain previous_boards.push(ascii). last one is current state
var touched = {}; //this allows us to easily determine if we have already processed an atom or bond. touched[x_y]=1;
var selected_square = "0_0"; //used for editor menu trigger square identification

//SVG graphics variables --------------------------
var svg = {};

svg["-"] = `<svg width="100%" height="100%"  viewBox="0 0 5 5">
<line x1="0" y1="2.5" x2="5" y2="2.5" style="stroke:black;stroke-width:2" />
</svg>`;

svg["+"] = `<svg width="100%" height="100%"  viewBox="0 0 5 5">
 <line x1="0" y1="2.5" x2="5" y2="2.5" style="stroke:black;stroke-width:1" />
 <line x1="2.5" y1="0" x2="2.5" y2="5" style="stroke:black;stroke-width:1" />
</svg>`;

svg["."] = `<svg width="100%" height="100%"  viewBox="0 0 5 5">
<circle cx="2.5" cy="2.5" r="1.5" stroke="black" stroke-width="1" fill="black">
</svg>`;

svg.valence_0 = ``;

svg.valence_1 = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 49 25 A 24 24 0 1 1 48 17 z" />
  </circle>
</svg>`;

svg.valence_2 = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 49 25 A 24 24 0 1 1 48 17 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 1 25 A 24 24 0 1 1 2 33 z" />
  </circle>
</svg>`;

svg.valence_3 = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 49 25 A 24 24 0 1 1 48 17 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 13 46 A 24 24 0 1 1 21 49 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 13 4 A 24 24 0 1 1 7 10 z" />
  </circle>
</svg>`;

svg.valence_4 = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path=" M 1 24 A 24 24 0 1 1 1 25 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 26 1 A 24 24 90 1 1 25 1 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 49 26 A 24 24 180 1 1 49 25 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 24 49 A 24 24 270 1 1 25 49 z" />
  </circle>
</svg>`;

svg.solid_circle = `<svg width="100%" height="100%"  viewBox="0 0 50 50"><circle cx="50%" cy="50%" r="47%" stroke="black" stroke-width="2" fill="transparent"></circle></svg>`;

svg.dash_circle = `<svg width="100%" height="100%"  viewBox="0 0 50 50"><circle cx="25" cy="25" r="24" stroke="black" stroke-width="2" stroke-dasharray="5,5" fill="transparent"></circle></svg>`;

svg.h = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle class="dash" cx="25" cy="25" r="24"  fill="white"></circle>
<text font-family='arial' font-color='black' x="50%" y="50%"  text-anchor="middle" stroke="black" stroke-width="1px" dy=".3em">He</text>
</svg>`;

svg.H = `<svg width="100%" height="100%" stroke="transparent" stroke-width="2" viewBox="0 0 50 50">
<circle cx="50%" cy="50%" r="47%" fill="IndianRed"></circle>
<text x="50%" y="50%" text-anchor="middle" stroke="#51c5cf" stroke-width="2px" dy=".3em">H</text>
</svg>`;

svg.O = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="25" cy="25" r="24"  fill="CornflowerBlue"></circle>
<text x="25" y="25" text-anchor="middle" stroke="#51c5cf" stroke-width="2px" dy=".3em">O</text>
</svg>`;

svg.N = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="25" cy="25" r="24" fill="LightGreen"></circle>
<text x="25" y="25" text-anchor="middle" stroke="#51c5cf" stroke-width="2px" dy=".3em">N</text>
</svg>`;

svg.C = `<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="25" cy="25" r="24" fill="Khaki"></circle>
<text x="25" y="25" text-anchor="middle" stroke="#51c5cf" stroke-width="2px" dy=".3em">C</text>
</svg>`;

svg.bond_vert_1 = `<svg width="100%" height="100%"  viewBox="0 0 5 50">
 <line x1="0" y1="25" x2="5" y2="25" style="stroke:black;stroke-width:2" />
</svg>`;

svg.bond_vert_2 = `<svg width="100%" height="100%"  viewBox="0 0 5 50">
 <line x1="0" y1="17" x2="5" y2="17" style="stroke:black;stroke-width:2" />
 <line x1="0" y1="35" x2="5" y2="35" style="stroke:black;stroke-width:2" />
svg>`;

svg.bond_vert_3 = `<svg width="100%" height="100%"  viewBox="0 0 5 50">
 <line x1="0" y1="12.5" x2="5" y2="12.5" style="stroke:black;stroke-width:2" />
 <line x1="0" y1="25" x2="5" y2="25" style="stroke:black;stroke-width:2" />
 <line x1="0" y1="37.5" x2="5" y2="37.5" style="stroke:black;stroke-width:2" />
svg>`;

svg.bond_vert_4 = `<svg width="100%" height="100%"  viewBox="0 0 5 50">
 <line x1="0" y1="10" x2="5" y2="10" style="stroke:black;stroke-width:2" />
 <line x1="0" y1="20" x2="5" y2="20" style="stroke:black;stroke-width:2" />
 <line x1="0" y1="30" x2="5" y2="30" style="stroke:black;stroke-width:2" />
 <line x1="0" y1="40" x2="5" y2="40" style="stroke:black;stroke-width:2" />
svg>`;

svg.bond_horiz_1 = `<svg width="100%" height="100%"  viewBox="0 0 50 5">
 <line x1="25" y1="0" x2="25" y2="5" style="stroke:black; stroke-width:2" />
</svg>`;

svg.bond_horiz_2 = `<svg width="100%" height="100%"  viewBox="0 0 50 5">
 <line x1="17" y1="0" x2="17" y2="5" style="stroke:black; stroke-width:2" />
 <line x1="35" y1="0" x2="35" y2="5" style="stroke:black; stroke-width:2" />
</svg>`;

svg.bond_horiz_3 = `<svg width="100%" height="100%"  viewBox="0 0 50 5">
 <line x1="12.5" y1="0" x2="12.5" y2="5" style="stroke:black; stroke-width:2" />
 <line x1="25" y1="0" x2="25" y2="5" style="stroke:black; stroke-width:2" />
 <line x1="37.5" y1="0" x2="37.5" y2="5" style="stroke:black; stroke-width:2" />
</svg>`;

svg.bond_horiz_4 = `<svg width="100%" height="100%"  viewBox="0 0 50 5">
 <line x1="10" y1="0" x2="10" y2="5" style="stroke:black; stroke-width:2" />
 <line x1="20" y1="0" x2="20" y2="5" style="stroke:black; stroke-width:2" />
 <line x1="30" y1="0" x2="30" y2="5" style="stroke:black; stroke-width:2" />
 <line x1="40" y1="0" x2="40" y2="5" style="stroke:black; stroke-width:2" />
</svg>`;

svg.win = `<table>
<tr>
<td class="win_vacuum">

<svg width="100%" height="100%" stroke="transparent" stroke-width="2" viewBox="0 0 50 50">
<circle cx="50%" cy="50%" r="47%" fill="IndianRed"></circle>
<text x="50%" y="50%" text-anchor="middle" stroke="#51c5cf" stroke-width="2px" dy=".3em">W</text>
</svg>

<svg width="100%" height="100%"  viewBox="0 0 50 50"><circle cx="25" cy="25" r="24" stroke="black" stroke-width="2" stroke-dasharray="5,5" fill="transparent"></circle></svg>

<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 49 25 A 24 24 0 1 1 48 17 z" />
  </circle>
</svg>

</td>
<td class="win_bond_vert">

<svg width="100%" height="100%"  viewBox="0 0 5 50">
 <line x1="0" y1="25" x2="5" y2="25" style="stroke:black;stroke-width:2" />
</svg>

</td>
<td class="win_vacuum">
<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="25" cy="25" r="24"  fill="CornflowerBlue"></circle>
<text x="25" y="25" text-anchor="middle" stroke="#51c5cf" stroke-width="2px" dy=".3em">I</text>
</svg>

<svg width="100%" height="100%"  viewBox="0 0 50 50"><circle cx="50%" cy="50%" r="47%" stroke="black" stroke-width="2" fill="transparent"></circle></svg>
<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 49 25 A 24 24 0 1 1 48 17 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 1 25 A 24 24 0 1 1 2 33 z" />
  </circle>
</svg>

</td>
</tr>

<tr>
<td class="win_bond_horiz"></td>
<td class="win_bond_hyperspace"></td>
<td class="win_bond_horiz">

<svg width="100%" height="100%"  viewBox="0 0 50 5">
 <line x1="25" y1="0" x2="25" y2="5" style="stroke:black; stroke-width:2" />
</svg>

</td>
</tr>

<tr><td class="win_vacuum">
</td>
<td class="win_bond_vert">
</td>
<td class="win_vacuum">

<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="25" cy="25" r="24" fill="Khaki"></circle>
<text x="25" y="25" text-anchor="middle" stroke="#51c5cf" stroke-width="2px" dy=".3em">N</text>
</svg>

<svg width="100%" height="100%"  viewBox="0 0 50 50"><circle cx="50%" cy="50%" r="47%" stroke="black" stroke-width="2" fill="transparent"></circle></svg>

<svg width="100%" height="100%"  viewBox="0 0 50 50">
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path=" M 1 24 A 24 24 0 1 1 1 25 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 26 1 A 24 24 90 1 1 25 1 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 49 26 A 24 24 180 1 1 49 25 z" />
  </circle>
<circle cx="0" cy="0" r="5" stroke="black" stroke-width="2" fill="white">
<animateMotion dur="10s" repeatCount="indefinite"
      path="M 24 49 A 24 24 270 1 1 25 49 z" />
  </circle>
</svg>

</td>
</tr>
<table>`;

//alert vars -----------------------------
var how_to_play = `
Chemical Zen needs no instruction...

cursor/arrows=move : or click dashed boxes
r: reset puzzle
z: undo current move

Goal: Join all atoms with free valences
`;

var building_a_puzzle = `Building puzzles in ASCII:
-the first line is an x_y value indicating the location of the atom you will control
-the following lines are the columns and rows of the puzzle
-the top left is x=0 , y=0 x being columns and y being rows
-characters can be W,0,1,2,3,4,h,H,O,N,C,+,-,.
-W = walls -they must be in locations where x and y are both even
-0 (zero) = empty -they can go anywhere
1,2,3,4 = bonds -they can go anywhere between two atoms, up to the capacity of the smallest valence. x and y must be even/odd or odd/even
h = helium -It has no free valence bonds and cannot join to other atoms. It must be in locations where x and y are both even
H = hydrogen -It has 1 free valence bonds. It must be in locations where x and y are both even
O = oxygen -It has 2 free valence bonds. It must be in locations where x and y are both even
N = nitrogen -It has 3 free valence bonds. It must be in locations where x and y are both even
C = carbon -It has 4 free valence bonds. It must be in locations where x and y are both even
+ = bond adder -bonds crossing this will increase by 1 if the atoms have free valences
- = bond subtractor -bonds crossing this will decrease by 1
. = bond twister - bonds crossing this will wrap around it `;

//puzzle vars ------------------------
var puzzles = {};

puzzles.lotus = `8_2
000000W0W0W000000
00000000000000000
0000W0W0C0W0W0000
00000000000000000
00W0W0000000W0W00
00000000000000000
W0W000H000H000W0W
00000000000000000
W000000000000000W
00000000000000000
W0W000H000H000W0W
00000000000000000
00W0W0000000W0W00
00000000000000000
0000W0W000W0W0000
00000000000000000
000000W0W0W000000
`;

puzzles.rosie = `8_12
W0W0W0W0W0W0W0W0W
00000000000000000
W000000000000000W
00000000000000000
W000H000C000H000W
00000000000000000
W000000000000000W
00000000000000000
W000H000W000H000W
00000000000000000
W000000000000000W
00000000000000000
W000H000C000H000W
00000000000000000
W000000000000000W
00000000000000000
W0W0W0W0W0W0W0W0W
`;

puzzles.three_doors = `8_10
W0W0W0W0W0W0W0W0W
00000000000000000
W000000000000000W
00000000000000000
W000000000000000W
00000000000000000
W0W0H0W0C0W0H0W0W
00000000000000000
W000000000000000W
00000000000000000
W00000H0h0H00000W
00000000000000000
W000000000000000W
00000000000000000
W0W0W0W0W0W0W0W0W
`;

puzzles.long_legs = `2_4
00W0W0W0W0W0W0W00
00000000000000000
W0W00000000000W0W
000-000000000-000
W0H00000000000H0W
000-000000000-000
W0W00000C00000W0W
00000-0-0-0-00000
00W0W000W000W0W00
00000000000000000
0000W0H0W0H0W0000
00000000000000000
0000W0W0W0W0W0000
`;

puzzles.construction = `2_2
W0W0W0W0W0W0W0W
000000000000000
W0H000000000H0W
000.0.0.0.0.000
W000O000000000W
000.0.0.0.0.000
W0000000000000W
000.0.0-0.0.000
W0000000000000W
000.0.0.0.0.000
W000000000C000W
000.0.0.0.0.000
W0H000000000H0W
000000000000000
W0W0W0W0W0W0W0W
`;

//constructors ------------------------

function Atom(x, y, letter) {
  // Constructor
  this.is_a = "atom";
  this.x = x;
  this.y = y;
  this.letter = letter; //H, h, O, N, C
  this.valence = {
    h: 0,
    H: 1,
    O: 2,
    N: 3,
    C: 4
  }[letter]; //set on create based on letter

  if (x <= 0 || y <= 0 || x >= board.width || y >= board.hight) {
    //atoms cannot exist on edge. Only walls.
    alert("Atom cannot go on the edge");
    return new Empty(x, y, "0"); // return empty instead
  }

  this.Build_Molecules = function (molecule_number) {
    let x_y = this.x.toString() + "_" + this.y.toString();
    if (typeof molecule[x_y] != "undefined") {
      return false;
    } //already done this one
    molecule[x_y] = molecule_number;
    let all_news = Get_NEWS(this.x, this.y);
    for (let key in direction)
      if (direction.hasOwnProperty(key)) {
        //N,S,E,W
        let x_y_half_step = all_news[key].x_y_half_step;
        let x_y_full_step = all_news[key].x_y_full_step;
        if (board[x_y_half_step].is_a == "bond") {
          //there is a bond
          if (board[x_y_full_step].is_a === "atom") {
            //this is a bonded atom!
            board[x_y_full_step].Build_Molecules(molecule_number);
          }
        }
      }
    return true;
  };

  this.Molecule_Split = function (molecule_number) {
    //after a bond split, will change the molecule # for all bonded atoms to this atom
    let x_y = this.x.toString() + "_" + this.y.toString();
    if (molecule[x_y] == molecule_number) {
      return false;
    } //already done this one
    molecule[x_y] = molecule_number;
    let all_news = Get_NEWS(this.x, this.y);
    for (let key in direction)
      if (direction.hasOwnProperty(key)) {
        //N,S,E,W
        let x_y_half_step = all_news[key].x_y_half_step;
        let x_y_full_step = all_news[key].x_y_full_step;
        if (board[x_y_half_step].is_a == "bond") {
          //there is a bond
          if (board[x_y_full_step].is_a === "atom") {
            //this is a bonded atom!
            board[x_y_full_step].Molecule_Split(molecule_number);
          }
        }
      }
    return true;
  };

  this.Can_I_Move = function (NEWS) {
    //also transfers force
    //let dx = direction[NEWS].x;
    //let dy = direction[NEWS].y;
    let x_y = this.x.toString() + "_" + this.y.toString();
    let all_news = Get_NEWS(this.x, this.y);
    let x_y_half_step = all_news[NEWS].x_y_half_step;
    let x_y_full_step = all_news[NEWS].x_y_full_step;

    if (touched[x_y] === 1) {
      return true;
    } //already been here
    touched[x_y] = 1; //set this touched{x_y}=1 so we don't recurse into this atom again and create infite loops
    //1. check for a wall hit
    if (board[x_y_full_step].is_a === "wall") {
      return false;
    }

    //2. check to see if something else is moving to the same location
    if (atom_intended_move[x_y_full_step]) {
      return false;
    } //and atom is already moving here. fail
    //3. state atom's intention of moving here
    atom_intended_move[x_y_full_step] = 1; //used to ensure 2 atoms are not fighting to move to same space

    //switch 4 and 5 and do Molecule_Split() after every split. otherwise we fully authorize a move after a split when pushing against our own molecule atoms

    //5. can our molecule move
    //this is for bonds and atoms in our molecule!
    //see if bonds (not touched) can move
    //all_news = Get_NEWS(this.x, this.y); duplicate
    for (let key in all_news)
      if (all_news.hasOwnProperty(key)) {
        let x_y_half_step = all_news[key].x_y_half_step;
        let receiving_atom = all_news[key].x_y_full_step; //is where receiving atom is
        if (board[x_y_half_step].is_a === "bond") {
          if (
            !board[x_y_half_step].Can_I_Move(NEWS, key, x_y, receiving_atom)
          ) {
            return false;
          } //bond routine needs NEWS,transmitting_atom,recieving_atom
        }
      }

    //4. see if non bonded atom,not touched, not in our molecule, is in our way, and see if it can move
    if (board[x_y_half_step].is_a !== "bond") {
      //no bond in our way
      if (board[x_y_full_step].is_a === "atom") {
        //atom in our way
        if (touched[x_y_full_step] !== 1) {
          //hasn't been touched
          if (molecule[x_y] != molecule[x_y_full_step]) {
            //ONLY PUSH atoms that are not in our molecule!!!!
            if (!board[x_y_full_step].Can_I_Move(NEWS)) {
              return false;
            }
          }
        }
      }
    }

    //if here, all downstream tests are good to move. but this does not mean that the move will not fail due to another branch, atom, or wall
    //premature: //this.x should only be updated when we move.//this.x = this.x + dx + dx;//this.y = this.y + dy + dy;
    move[x_y] = x_y_full_step; //used to move atoms if we are good to go
    //or move[x_y] = '' + this.x + '_' + this.y;
    return true;
  };

  this.Join_To_Free_Atoms = function () {
    //original game seems to attach to atoms with a higher free valance value first. we may need to do this too. see gold-chandalier
    //to do this find largests to smallest free valances around us and make a NEWS_sorted_array we can use in for (var key in all_news) eg: for (var key in all_news_sorted_array)
    var NEWS_valances = {};
    var all_news_sorted_array = []; //pop?
    let all_news = Get_NEWS(this.x, this.y);
    for (var key in all_news)
      if (all_news.hasOwnProperty(key)) {
        let x_y_full_step = all_news[key].x_y_full_step;
        if (board[x_y_full_step].is_a === "atom") {
          NEWS_valances[key] = board[x_y_full_step].Return_Free_Valence();
        }
      }
    //sort the valences high to low
    all_news_sorted_array = Object.entries(NEWS_valances)
      .sort((a, b) => b[1] - a[1])
      .map((el) => el[0]);

    //Return_Free_Valence of this atom
    let free_valence = this.Return_Free_Valence();
    //for adjacent atoms in direction with no bond && adjacent atoms with free valence , create a bond until my free_valence === 0
    //for(var key in direction){
    all_news = Get_NEWS(this.x, this.y);
    //for (var key in all_news) {
    for (key of all_news_sorted_array) {
      //using sorted NEWS based on valences above
      if (free_valence <= 0) {
        return;
      }
      let x_half_step = all_news[key].x_half_step;
      let y_half_step = all_news[key].y_half_step;
      let x_y_half_step = all_news[key].x_y_half_step;
      let x_y_full_step = all_news[key].x_y_full_step;
      if (board[x_y_full_step].is_a === "atom") {
        if (board[x_y_full_step].Return_Free_Valence() > 0) {
          if (board[x_y_half_step].is_a === "empty") {
            sound_add_bond.play();
            board[x_y_half_step] = new Bond(x_half_step, y_half_step, 1); //add a bond
            free_valence--;
          }
        }
      }
    }
  };

  this.Return_Free_Valence = function () {
    //look in all directions and calculate
    let sum = 0;
    let free_valence;
    let all_news = Get_NEWS(this.x, this.y);
    for (let key in all_news)
      if (all_news.hasOwnProperty(key)) {
        let x_y = all_news[key].x_y_half_step;
        if (board[x_y].is_a === "bond") {
          sum = sum + parseInt(board[x_y].letter); //letter is ascii
        }
      }
    free_valence = this.valence - sum;
    if (free_valence < 0) {
      console.log("Impossible free_valence at " + x + "_" + y);
    }
    return free_valence;
  };

  return this; //return constructor
}

function Molecule_Split(transmitting_atom) {
  //var molecule_count = 0;
  molecule_last_count++; //find a free molecule #
  molecule_number = molecule_last_count;

  board[transmitting_atom].Molecule_Split(molecule_number); //will change all bonded atoms to this molecule
}

function Bond(x, y, letter) {
  this.is_a = "bond";
  this.x = x;
  this.y = y;
  //this.letter = letter; //ths is only used on bond creation. then we use value.
  //this.value = parseInt(letter);
  this.letter = letter;

  //all atom forces MUST be transmitted in order from source to receiver
  this.Can_I_Move = function (
    NEWS,
    NEWS_incomming_direction,
    transmitting_atom,
    receiving_atom
  ) {
    //also transfers force
    let dx = direction[NEWS].x;
    let dy = direction[NEWS].y;
    //note: this.x and this.y may be wrong
    // let xx = String_To_X_Y(transmitting_atom)[0] + dx;
    //let yy = String_To_X_Y(transmitting_atom)[1] + dy;
    // let x_y = xx.toString() + "_" + yy.toString();
    let x_y = this.x.toString() + "_" + this.y.toString();
    let all_news = Get_NEWS(this.x, this.y);
    let x_y_half_step = all_news[NEWS].x_y_half_step;
    //let x_y_full_step = all_news[NEWS].x_y_full_step;

    if (touched[x_y] === 1) {
      return true;
    } //already been here
    touched[x_y] = 1;

    //do half the move calculation here. IF . then we need to move initial direction + new direction. The new direction will be reflected in a changed dx and dy, and the initial direction if dx and dy are unchanged
    let half_move_x = this.x + dx;
    let half_move_y = this.y + dy;

    //1.is there a bond_modifyer in the path - y ?
    if (board[x_y_half_step].is_a === "bond_modifier") {
      if (board[x_y_half_step].letter === "-") {
        //reduce bond by 1. if 0, do not transmit force and return true
        board[x_y].letter--;
        if (board[x_y].letter <= 0) {
          sound_sub_bond.play();
          board[x_y] = new Empty(this.x, this.y, "0"); //remove bond
          Molecule_Split(transmitting_atom); //need to identify that molecule is, potentially, split!
          return true;
        }
      }

      if (board[x_y_half_step].letter === "+") {
        //if both joined atoms have free valences, join them
        if (
          board[transmitting_atom].Return_Free_Valence() > 0 &&
          board[receiving_atom].Return_Free_Valence() > 0
        ) {
          sound_add_bond.play();
          board[x_y].letter++;
        } //if not ignore and continue
      }

      if (board[x_y_half_step].letter === ".") {
        //new force to transfer to next atom is in direction of source atom
        //bond will move to original direction + new direction
        let anti = {
          N: "S",
          S: "N",
          E: "W",
          W: "E"
        };
        NEWS = anti[NEWS_incomming_direction];
        dx = direction[NEWS].x;
        dy = direction[NEWS].y;
      }
    }

    //transmit move / force to receiving atom
    if (!board[receiving_atom].Can_I_Move(NEWS)) {
      return false;
    }

    //move bond. second half of calculation, see above.
    //premature. this.x should only be updated when we move. //this.x = half_move_x + dx; // this.y = half_move_y + dy; //move[x_y] = "" + this.x + "_" + this.y; //used to move bond if we are good to go
    move[x_y] = "" + (half_move_x + dx) + "_" + (half_move_y + dy); //used to move bond if we are good to go
    return true;
  };

  return this;
}

function Empty(x, y, letter) {
  this.is_a = "empty";
  this.letter = letter;
  this.x = x;
  this.y = y;
  return this;
}

function Wall(x, y, letter) {
  this.is_a = "wall";
  this.x = x;
  this.y = y;
  this.letter = letter;
  return this;
}

function Bond_Modifier(x, y, letter) {
  this.is_a = "bond_modifier";
  this.x = x;
  this.y = y;
  this.letter = letter;
  return this;
  //- reduce bond by one
  //+ increase bond by one if joining atoms hav free valences
  // . if a bond hits it, the force transmitted by the bond will change to pull the receiving atom in the direction of the transmitting atom, the bond will move to
}

//board functions -----------------
function Objects_To_Create_Empty_HTML_Board() {
  let width = board.width;
  let height = board.height;
  let board_string = '<div id="puzzle_title">title</div>';
  board_string = board_string + '<table id="board_table">';
  for (let y = 0; y <= height; y++) {
    board_string = board_string + "<tr>";
    for (let x = 0; x <= width; x++) {
      var state = State(x, y);
      var x_y = X_Y_To_String(x, y);
      if (board_mode === "editor") {
        board_string =
          board_string +
          "<td id=" +
          x_y +
          ' class="' +
          state +
          ' editor" onmousedown="Place_Item_Menu(this.id);"></td>';
      } else {
        //z and r button cases
        if (x_y === "0_0") {
          //z
          board_string =
            board_string +
            "<td id=" +
            x_y +
            ' class="move_to ' +
            state +
            '" onmousedown="Key_Input(90);"><center>z</center></td>';
        } else if (x_y === "2_0") {
          //r
          board_string =
            board_string +
            "<td id=" +
            x_y +
            ' class="move_to ' +
            state +
            '" onmousedown="Key_Input(82);"><center>r</center></td>';
        } else {
          //everything else
          board_string =
            board_string +
            "<td id=" +
            x_y +
            ' class="' +
            state +
            '" ontouchend="Mouse_Down(this.id);" onclick="Mouse_Down(this.id);"> </td>';
        }
      }
    }
    board_string = board_string + "</tr>";
  }
  board_string = board_string + "</table>";
  document.getElementById("board").innerHTML = board_string;
}

function Objects_To_Place_Pieces_On_HTML_Board() {
  Build_Molecules();
  let element = document.getElementById("puzzle_title");
  element.innerHTML = board.title;
  for (let y = 0; y <= board.height; y++) {
    for (let x = 0; x <= board.width; x++) {
      let x_y = X_Y_To_String(x, y);
      if (typeof board[x_y] === "undefined") {
        continue;
      } //nothing here
      let letter = board[x_y].letter;
      element = document.getElementById(x_y);
      element.classList.remove("selected"); //reset possible selected classes
      if (x_y != "0_0" && x_y != "2_0") {
        //z r ignore
        element.classList.remove("move_to"); //reset possible move classes
      }
      //highlight possible moves
      let news = Get_NEWS(board.x_me, board.y_me);
      if (news.N.x_y_full_step === x_y) {
        element.classList.add("move_to");
      }
      if (news.E.x_y_full_step === x_y) {
        element.classList.add("move_to");
      }
      if (news.W.x_y_full_step === x_y) {
        element.classList.add("move_to");
      }
      if (news.S.x_y_full_step === x_y) {
        element.classList.add("move_to");
      }

      if (board[x_y].is_a === "empty") {
        if (x_y != "0_0" && x_y != "2_0") {
          //z r ignore
          element.innerHTML = "<div class=content></div>";
        }
        element.classList.remove("me");
        element.classList.remove("wall");
        element.classList.remove("atom");
      }
      if (board[x_y].is_a === "wall") {
        if (x_y != "0_0" && x_y != "2_0") {
          //z r ignore
          element.innerHTML = "<div class=content></div>";
        }
        element.classList.add("wall");
      }
      if (board[x_y].is_a === "atom") {
        element.classList.remove("wall");
        let temp = svg[letter]; //atom text and color
        if (x === board.x_me && y === board.y_me) {
          temp = temp + svg.dash_circle; //dashed circle
          element.classList.add("me");
        } else {
          temp = temp + svg.solid_circle; //normal circle
        }
        temp = temp + svg["" + "valence_" + board[x_y].Return_Free_Valence()]; //get valance
        element.innerHTML = temp;
      }
      if (board[x_y].is_a === "bond") {
        let state = State(x, y); //can't use className as it might have trailing editor
        element.innerHTML = svg["" + state + "_" + board[x_y].letter];
      }
      if (board[x_y].is_a === "bond_modifier") {
        element.innerHTML = svg[letter];
      }
    }
  }
}

function Build_Puzzle(input_string) {
  //called on load, z key, and r key. it creates html board and places pieces on board so no save state stuff here
  //build display board and board objects
  let element = document.getElementById("win");
  element.classList.remove("win");
  element.innerHTML = "";
  if (board_mode === "game") {
    document.getElementById("ASCII").style.display = "none";
  } else {
    document.getElementById("ASCII").style.display = "block";
  }
  ASCII_To_Objects(input_string);
  Join_Free_Atoms();
  Objects_To_Create_Empty_HTML_Board();
  Objects_To_Place_Pieces_On_HTML_Board();
}

//object  functions
function ASCII_To_Objects(ascii_string) {
  Prep_New_Board();
  ascii_string = ascii_string.trim();
  let lines = ascii_string.split("\n"); //1st line is my position
  let x_y_me = lines.shift().trim();
  board.x_y_me = x_y_me; //from string
  [board.x_me, board.y_me] = String_To_X_Y(x_y_me);
  let y = -1;
  for (let line of lines) {
    line = line.trim();
    y++;
    if (y > board.height) {
      board.height = y;
    } //find the height
    var x = -1;
    for (let letter of line) {
      x++;
      if (x > board.width) {
        board.width = x;
      } //find the width
      var state = State(x, y);
      var x_y = X_Y_To_String(x, y);
      if (!validate_board_pos[state].includes(letter)) {
        error_msg =
          error_msg +
          "Letter " +
          letter +
          " not allowed in " +
          state +
          " position + " +
          x_y +
          ". ";
        console.log(error_msg);
      }
      //create the board[x_y] objects
      //0 indicates empty only
      if (empty_chars.includes(letter)) {
        board[x_y] = new Empty(x, y, letter);
      }
      if (bond_chars.includes(letter)) {
        board[x_y] = new Bond(x, y, letter);
      }
      if (wall_chars.includes(letter)) {
        board[x_y] = new Wall(x, y, letter);
      }
      if (atom_chars.includes(letter)) {
        board[x_y] = new Atom(x, y, letter);
      }
      if (modifier_chars.includes(letter)) {
        board[x_y] = new Bond_Modifier(x, y, letter);
      }
    }
  }
  if (error_msg !== "") {
    alert(error_msg);
  }
  Join_Free_Atoms();
}

//as we can only easily save objects as json, and json strips the methods, we need this routine to add the methods to the json objects
function Restore_Object_Methods_From_JSON(json_string) {
  board = JSON.parse(json_string);
  for (let key in board)
    if (board.hasOwnProperty(key)) {
      let x, y;
      [x, y] = String_To_X_Y(key);
      if (board[key].is_a === "wall") {
        board[key] = new Wall(x, y, board[key].letter);
      }
      if (board[key].is_a === "empty") {
        board[key] = new Empty(x, y, board[key].letter);
      }
      if (board[key].is_a === "bond") {
        //board[key] = new Bond(x, y, board[key].value);
        board[key] = new Bond(x, y, board[key].letter);
      }
      if (board[key].is_a === "atom") {
        board[key] = new Atom(x, y, board[key].letter);
      }
    }
}

//editor functions -------------------------

function Blank_Editor_ASCII() {
  let x_squares = 10;
  let y_squares = 10;
  let x_size = x_squares * 2 - 2;
  let y_size = y_squares * 2 - 2;
  let ascii_text = "2_2";
  //build a blank x by y ascii. easy way to make clear board!
  for (let y = 0; y <= y_size; y++) {
    ascii_text = ascii_text + "\r\n";
    for (let x = 0; x <= x_size; x++) {
      ascii_text = ascii_text + "0";
    }
  }
  return ascii_text;
}

function Place_Item_Menu(square_id) {
  //show menu
  //let x = event.clientX; // Get the horizontal coordinate
  //let y = event.clientY; // Get the vertical coordinate
  let element = document.getElementById("Item_Menu");
  // element.style.left = x + "px";
  //element.style.top = y + "px";
  element.style.display = "block";
  selected_square = square_id;
  //show / block menu items
  document.getElementById(square_id).classList.add("selected"); //highlight box to edit
  let class_is = document.getElementById(square_id).classList[0];
  if (class_is === "vacuum") {
    document.getElementById("Item_Menu_Atoms").style.display = "block";
    document.getElementById("Item_Menu_Bonds").style.display = "none";
    document.getElementById("Item_Menu_Modifiers").style.display = "none";
  }
  if (class_is.includes("bond")) {
    document.getElementById("Item_Menu_Atoms").style.display = "none";
    document.getElementById("Item_Menu_Bonds").style.display = "block";
    document.getElementById("Item_Menu_Modifiers").style.display = "none";
  }
  if (class_is === "hyperspace") {
    document.getElementById("Item_Menu_Atoms").style.display = "none";
    document.getElementById("Item_Menu_Bonds").style.display = "none";
    document.getElementById("Item_Menu_Modifiers").style.display = "block";
  }
}

function Make_Me() {
  //hide menu
  let element = document.getElementById("Item_Menu");
  element.style.display = "none";

  let x_y = selected_square;
  board.x_y_me = x_y;
  let [x, y] = String_To_X_Y(x_y);
  board.x_me = x;
  board.y_me = y;
  Objects_To_Place_Pieces_On_HTML_Board(); //need to redraw to update svg
  document.getElementById("input_area").value = Board_To_ASCII();
}

function Place_Item(letter) {
  let x_y = selected_square;
  let [x, y] = String_To_X_Y(x_y);
  if (empty_chars.includes(letter)) {
    board[x_y] = new Empty(x, y, letter);
  }
  if (bond_chars.includes(letter)) {
    board[x_y] = new Bond(x, y, letter);
  }
  if (wall_chars.includes(letter)) {
    board[x_y] = new Wall(x, y, letter);
  }
  if (atom_chars.includes(letter)) {
    board[x_y] = new Atom(x, y, letter);
  }
  if (modifier_chars.includes(letter)) {
    board[x_y] = new Bond_Modifier(x, y, letter);
  }
  //check for bonds
  Join_Free_Atoms();
  Objects_To_Place_Pieces_On_HTML_Board();

  document.getElementById(x_y).classList.remove("selected"); //de-highlight box to edit

  //hide menu
  let element = document.getElementById("Item_Menu");
  element.style.display = "none";

  document.getElementById("input_area").value = Board_To_ASCII();
  //Save editor state
  localStorage.editor_board = document.getElementById("input_area").value;
}

function Board_To_ASCII() {
  //convert to ascii
  let ascii_string = board.x_y_me.trim() + "\r\n";
  for (let y = 0; y <= board.height; y++) {
    for (let x = 0; x <= board.width; x++) {
      if (typeof board[x + "_" + y].letter === "undefined") {
        board[x + "_" + y].letter = "0";
      }
      ascii_string = ascii_string + board[x + "_" + y].letter;
    }
    ascii_string = ascii_string + "\r\n";
  }
  return ascii_string;
}

function Crop_Editor_Board() {
  //build ascii and put in input_box
  let left_wall = 0;
  let x_size = board.width;
  let right_wall = board.width;
  let top_wall = 0;
  let y_size = board.height;
  let bottom_wall = board.height;
  let trigger;
  //find left wall
  trigger = false;
  for (x = 0; x <= x_size; x++) {
    for (y = 0; y <= y_size; y++) {
      if (board[x + "_" + y].is_a != "empty") {
        trigger = true;
        break;
      }
    }
    if (trigger == true) {
      break;
    }
  }
  left_wall = x;
  //find right wall
  trigger = false;
  for (x = x_size; x >= 0; x--) {
    for (y = 0; y <= y_size; y++) {
      if (board[x + "_" + y].is_a != "empty") {
        trigger = true;
        break;
      }
    }
    if (trigger == true) {
      break;
    }
  }
  right_wall = x;
  //find top wall
  trigger = false;
  for (y = 0; y <= y_size; y++) {
    for (x = 0; x <= x_size; x++) {
      if (board[x + "_" + y].is_a != "empty") {
        trigger = true;
        break;
      }
    }
    if (trigger == true) {
      break;
    }
  }
  top_wall = y;
  //find bottom wall
  trigger = false;
  for (y = y_size; y >= 0; y--) {
    for (x = 0; x <= x_size; x++) {
      if (board[x + "_" + y].is_a != "empty") {
        trigger = true;
        break;
      }
    }
    if (trigger == true) {
      break;
    }
  }
  bottom_wall = y;
  //convert x_y_me_editor to x_y_me based on top_wall and left_wall
  [x, y] = String_To_X_Y(board.x_y_me);
  board.x_y_me = x - left_wall + "_" + (y - top_wall);
  //convert to ascii
  let ascii_string = board.x_y_me.trim() + "\r\n";
  for (y = top_wall; y <= bottom_wall; y++) {
    for (x = left_wall; x <= right_wall; x++) {
      ascii_string = ascii_string + board[x + "_" + y].letter;
    }
    ascii_string = ascii_string + "\r\n";
  }

  //save to input_box
  document.getElementById("input_area").value = ascii_string;
  Build_Puzzle(ascii_string);
}

//general functions -------------------------
function Prep_New_Board() {
  board = {};
  board.x_me = 0;
  board.y_me = 0;
  board.width = 0;
  board.height = 0;
  move = {};
  atom_intended_move = {};
  touched = {};
  error_msg = "";
}

//suspect orig bonds to biggest nearby free valance first! See chandeliere puzzle.
//fixed with reservations. seems like cheating!
function Join_Free_Atoms() {
  if (board[board.x_y_me].is_a === "atom") {
    board[board.x_y_me].Join_To_Free_Atoms(); //do me first
  }
  for (let key in board) {
    //do all other atoms
    if (board[key].is_a === "atom") {
      board[key].Join_To_Free_Atoms();
    }
  }
}

function Build_Molecules() {
  molecule = {};
  var molecule_count = 0;
  for (let y = 0; y <= board.height; y++) {
    for (let x = 0; x <= board.width; x++) {
      let x_y = x + "_" + y;
      if (board[x_y].is_a === "atom") {
        if (typeof molecule[x_y] == "undefined") {
          //ignore ones we have already checked
          molecule_count++; //if here, this must be a brand new molecule
          board[x_y].Build_Molecules(molecule_count); //will add all bonded atoms to this molecule
        }
      }
    }
  }
  molecule_last_count = molecule_count; //save last molecule for Molecule_Split()
}

function win_routine() {
  sound_win.play();
  let element = document.getElementById("win");
  element.innerHTML = svg.win;
  element.classList.add("win");
}

function Check_For_Win() {
  let free_valences = 0;
  for (let key in board) {
    if (board[key].is_a === "atom") {
      free_valences = free_valences + board[key].Return_Free_Valence();
    }
  }
  if (free_valences === 0) {
    //winner winner chicken diner
    setTimeout(win_routine, 1000);
  }
}

function X_Y_To_String(x, y) {
  return x.toString() + "_" + y.toString();
}

function String_To_X_Y(x_y) {
  //returns [x,y] int
  if (typeof x_y === "undefined") {
    return [0, 0];
  }
  let x, y;
  [x, y] = x_y.split("_");
  return [parseInt(x), parseInt(y)];
}

function Get_NEWS(x, y) {
  let news = {};
  for (let key in direction)
    if (direction.hasOwnProperty(key)) {
      let dx = direction[key].x;
      let dy = direction[key].y;
      let x_half_step = x + dx;
      let y_half_step = y + dy;
      let x_full_step = x + dx + dx;
      let y_full_step = y + dy + dy;
      let x_y_half_step = x_half_step + "_" + y_half_step;
      let x_y_full_step = x_full_step + "_" + y_full_step;
      news[key] = {};
      news[key].x_half_step = x_half_step;
      news[key].y_half_step = y_half_step;
      news[key].x_full_step = x_full_step;
      news[key].y_full_step = y_full_step;
      news[key].x_y_half_step = x_y_half_step;
      news[key].x_y_full_step = x_y_full_step;
    }
  return news;
}

function State(x, y) {
  let x_odd = x % 2;
  let y_odd = y % 2;
  if (x_odd && y_odd) {
    return "hyperspace";
  }
  if (!x_odd && !y_odd) {
    return "vacuum";
  }
  if (x_odd && !y_odd) {
    return "bond_vert";
  }
  if (!x_odd && y_odd) {
    return "bond_horiz";
  }
}

//https://www.w3schools.com/graphics/game_sound.asp
function sound(src) {
  this.sound = document.createElement("audio");
  this.sound.src = src;
  this.sound.setAttribute("preload", "auto");
  this.sound.setAttribute("controls", "none");
  this.sound.style.display = "none";
  document.body.appendChild(this.sound);
  this.play = function () {
    this.sound.play();
  };
  this.stop = function () {
    this.sound.pause();
  };
}

var sound_fail = new sound(
  "https://www.emogic.com/Sokobond_JS/Windows Critical Stop.mp3"
);
var sound_add_bond = new sound(
  "https://www.emogic.com/Sokobond_JS/Windows Hardware Insert.mp3"
);
var sound_sub_bond = new sound(
  "https://www.emogic.com/Sokobond_JS/Windows Hardware Remove.mp3"
);
var sound_win = new sound(
  "https://www.emogic.com/Sokobond_JS/Windows Notify Calendar.mp3"
);
var sound_move = new sound(
  "https://www.emogic.com/Sokobond_JS/Windows Balloon.mp3"
);

function Mouse_Down(x_y) {
  let news;
  news = Get_NEWS(board.x_me, board.y_me);
  if (news.N.x_y_full_step === x_y) {
    Key_Input(38);
  }
  if (news.E.x_y_full_step === x_y) {
    Key_Input(39);
  }
  if (news.W.x_y_full_step === x_y) {
    Key_Input(37);
  }
  if (news.S.x_y_full_step === x_y) {
    Key_Input(40);
  }
}
//main routine Key input --------------------------

function Key_Input(keyCode) {
  if (document.activeElement === document.getElementById("input_area")) {
    return;
  }
  if (keyCode == 82) {
    //r 82
    Build_Puzzle(previous_boards[0]);
    previous_boards = previous_boards.slice(0, 1); //only keep the first array element
    Save_State();
    return;
  }
  if (keyCode == 90) {
    //z:undo
    if (previous_boards.length > 1) {
      previous_boards.pop(); //last array item is current puzzle. remove it
      Build_Puzzle(previous_boards[previous_boards.length - 1]);
      Save_State();
      return; //do not hit move routine
    }
  }
  let move_key_pressed = false;
  let NEWS;
  if (keyCode == 37) {
    //left
    NEWS = "W";
    move_key_pressed = true;
  }
  if (keyCode == 38) {
    //up
    NEWS = "N";
    move_key_pressed = true;
  }
  if (keyCode == 39) {
    //right
    NEWS = "E";
    move_key_pressed = true;
  }
  if (keyCode == 40) {
    //down
    NEWS = "S";
    move_key_pressed = true;
  }
  if (move_key_pressed) {
    //clear and get ready for another move
    //Build_Molecules();
    move = {};
    atom_intended_move = {};
    touched = {};

    let premove_board = JSON.stringify(board); //so we can perfectly reset board on failed move

    if (board[board.x_me + "_" + board.y_me].Can_I_Move(NEWS)) {
      sound_move.stop();
      sound_move.play(); //make a happy sound
      //all moves are in move[x_y] = 'x_y_new'
      //so for all pre-moves (keys) copy all the "references" of the atom or bond object : temp[x_y]  = board[x_y] then board[x_y] = new empty(x,y)
      //create a new Empty object at the old location
      //then for each x_y key copy the "references" of the atom or board object to new position board[x_y_new] = temp[x_y]
      let temp = {};
      let key;
      for (key in move)
        if (move.hasOwnProperty(key)) {
          //save temp reference for all moving board objects. then remove the board references (set to empty)
          temp[key] = board[key];
          board[key] = new Empty(String_To_X_Y(key), "0");
        }
      for (key in move)
        if (move.hasOwnProperty(key)) {
          //now set all moved board references
          let new_x_y = move[key];
          board[new_x_y] = temp[key];
          [board[new_x_y].x, board[new_x_y].y] = String_To_X_Y(new_x_y); //set atom or bond this.x , this.y to new values
        }
      //move me locator variable
      board.x_y_me = move[board.x_me + "_" + board.y_me];
      [board.x_me, board.y_me] = String_To_X_Y(board.x_y_me);
      Join_Free_Atoms(); //for every atom, check for atoms that can bond
      //save board state
      previous_boards.push(Board_To_ASCII()); //for z - undo
    } else {
      //nothing has moved, but reset board objects with last board state as some x,y may be wrong. recursive fail routine will miss some objects
      sound_fail.play(); //make a sad sound
      Restore_Object_Methods_From_JSON(premove_board);
    }
    Objects_To_Place_Pieces_On_HTML_Board();
    Save_State();
    Check_For_Win();
  }
}

//load and save routines ------------------------------------------

function Save_State() {
  if (supports_html5_storage() == false) {
    return;
  }
  try {
    localStorage.previous_boards = JSON.stringify(previous_boards);
  } catch (err) {
    //Block of code to handle errors
    console.log(err + " out lof local storage space. Lots of moves Batman!");
    //remove 2 moves
    previous_boards.shift();
    previous_boards.shift();
    Save_State(); //try agian. Is this wise?
  } finally {
  }
}

function supports_html5_storage() {
  try {
    return "localStorage" in window && window.localStorage !== null;
  } catch (e) {
    return false;
  }
}

function Load_Puzzle(puzzle) {
  board_mode = "game";
  document.getElementById("input_area").value = puzzles[puzzle];
  previous_boards = [];
  previous_boards.push(puzzles[puzzle]);
  Build_Puzzle(puzzles[puzzle]);
  board.title = puzzle;
  Join_Free_Atoms();
  Objects_To_Place_Pieces_On_HTML_Board();
  Save_State();
}

function Factory_Reset() {
  previous_boards.splice(0, previous_boards.length); //delete array
  delete localStorage.editor_board;
  delete localStorage.previous_boards;
}

//main start up routines
function Game() {
  var ascii;
  board_mode = "game";

  if (!supports_html5_storage()) {
    alert("This browser does not support HTML 5 localStorage");
    return;
  }

  if (
    typeof localStorage.previous_boards !== "undefined" &&
    localStorage.previous_boards !== []
  ) {
    previous_boards = JSON.parse(localStorage.previous_boards);
    ascii = previous_boards[previous_boards.length - 1]; //last array item is current puzzle
    document.getElementById("input_area").value = previous_boards[0]; //get board start state
    Build_Puzzle(ascii);
  } else {
    let name = Object.keys(puzzles)[0]; //returns first game name in puzzles
    ascii = puzzles[name];
    document.getElementById("input_area").value = ascii;
    Build_Puzzle(ascii);
    previous_boards = [];
    previous_boards.push(ascii);
    Save_State();
  }
}

function Editor() {
  board_mode = "editor";
  let ascii_text;
  if (typeof localStorage.editor_board === "undefined") {
    // no stored editor
    ascii_text = Blank_Editor_ASCII();
  } else {
    //stored editor
    ascii_text = localStorage.editor_board;
  }
  document.getElementById("input_area").value = ascii_text;
  Build_Puzzle(ascii_text);
  localStorage.editor_board = ascii_text;
}

//free roaming code ----------------------------
Game();

//build puzzle drop down
var keys = Object.keys(puzzles);
for (var key of keys) {
  let select_box = document.getElementById("puzzle_select");
  let option = document.createElement("option");
  option.text = key;
  option.value = key;
  select_box.add(option);
}

//disable arrow keys from scrolling page
window.addEventListener(
  "keydown",
  function (e) {
    // space and arrow keys
    if ([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
      e.preventDefault();
    }
  },
  false
);
    </script>

  

</body>

</html>
 
